# Morph Catalog

This is a catalog of source and target schemas. Each connector follows a standard directory structure that facilitates the transformation of Airbyte source schemas into target schemas like Fivetran-compatible formats.

Assets in the catalog are a combination of:

- Airbyte source schema info, obtained from the connector's `schema` folder or via discovery.
- Target schemas, such as those we want to reshape our source data into.
- Generated files, file artifacts generated by our processes.

## Directory Structure

Using the Hubspot connector as an example, here's the standard directory structure for connectors in the catalog:

```
catalog/hubspot/
├── src/
│   └── transforms/
│       └── fivetran-interop/
│           ├── company.yml
│           ├── contact.yml
│           ├── deal.yml
│           ├── form.yml
│           ├── owner.yml
│           └── ticket.yml
├── requirements/
│   └── fivetran-interop/
│       └── src_hubspot.yml
├── generated/
│   ├── airbyte-catalog.json
│   ├── src_airbyte_hubspot.yml
│   └── dbt_project/
│       ├── models/
│       │   ├── contact.sql
│       │   ├── company.sql
│       │   ├── deal.sql
│       │   ├── form.sql
│       │   ├── owner.sql
│       │   ├── ticket.sql
│       │   └── sources.yml
│       ├── dbt_project.yml
│       └── ...
└── examples/
    └── dbt_fivetran_compat/
        ├── README.md
        ├── dbt_project.yml
        ├── packages.yml
        └── ...
```

### Components

#### 1. `src/transforms/`

Contains YAML mapping files that define transformations from Airbyte source schemas to target schemas. Each mapping file:

- Defines the domain and transforms
- Specifies source tables in the `from` section
- Maps fields from source to target
- Provides descriptions for each field
- Documents unused source fields

Example from contact.yml:
```yaml
domain: hubspot.fivetran-interop
transforms:
  - display_name: Fivetran Raw 'Contact' Model
    id: contact
    from:
      - contacts: airbyte_raw_hubspot.contacts
    fields:
      _fivetran_deleted:
        expression: contacts.archived
        description: "Boolean to mark rows that were deleted in the source database."
      property_firstname:
        expression: contacts.properties_firstname
        description: "The first name of the contact."
      # ... other fields
```

#### 2. `requirements/`

Contains the target schema definitions that transformations should conform to. These files:

- Define the structure of the target schema
- Specify field names, types, and descriptions
- Serve as the reference for creating mapping files

#### 3. `generated/`

Contains files generated by the morph tool:

- `dbt_project/`: A complete dbt project with:
  - SQL models generated from mapping files
  - sources.yml defining the Airbyte source tables
  - dbt configuration files
- `airbyte-catalog.json`: The Airbyte catalog definition
- `src_airbyte_hubspot.yml`: The dbt source definition based on the Airbyte catalog

#### 4. `examples/`

Contains example projects demonstrating how to use the generated models:

- `dbt_fivetran_compat/`: An example dbt project that uses the generated models
- Configuration files showing how to integrate with existing dbt packages

## Adding a New Connector

To add a new connector to the catalog:

1. Create a directory structure following the pattern above:
   ```
   catalog/new_connector/
   ├── src/transforms/
   │   └── fivetran-interop/
   ├── requirements/
   │   └── fivetran-interop/
   └── examples/
   ```

2. Add the target schema definition in `requirements/fivetran-interop/src_new_connector.yml`

3. Create mapping files in `src/transforms/fivetran-interop/` for each table to transform:
   - Define the domain (e.g., `new_connector.fivetran-interop`)
   - Specify source tables and their aliasing
   - Map fields from source to target schema
   - Document field descriptions and unused fields

4. Generate the dbt project using the morph CLI:
   ```bash
   python -m morph generate-dbt-project catalog/new_connector catalog/new_connector/airbyte-catalog.json
   ```

5. Create example projects in the `examples/` directory to demonstrate usage

## Mapping File Structure

Mapping files define how to transform source data to target schemas. Key components:

- `domain`: Namespace for the transforms (e.g., `hubspot.fivetran-interop`)
- `transforms`: List of transformations to apply
  - `id`: Identifier for the transform (becomes the model name)
  - `display_name`: Human-readable name for the transform
  - `from`: Source tables to use in the transform
  - `fields`: Target fields and how to populate them
    - `expression`: SQL expression or source field reference
    - `description`: Description of the field's purpose
  - `annotations`: Additional metadata about the transform
    - `unused_source_fields`: Fields in source not used in the transform

When mapping fields:
- Direct mappings use dot notation: `table_alias.field_name`
- Missing fields use the `MISSING` placeholder to indicate NULL values
- Field descriptions should match those in the target schema
